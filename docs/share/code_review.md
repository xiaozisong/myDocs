<!--
 * @Descripttion: 
 * @version: 
 * @Author: qiuxchao
 * @Date: 2022-05-23 11:10:24
 * @LastEditors: qiuxchao
 * @LastEditTime: 2022-07-27 14:38:07
-->
# Gitlab MR ç»“åˆé’‰é’‰æœºå™¨äººçš„è‡ªåŠ¨åŒ– Code Review

## èƒŒæ™¯ğŸ”…

åœ¨å›¢é˜Ÿä¸­ï¼Œå¤§å®¶çš„æŠ€æœ¯èƒ½åŠ›ã€ç»éªŒéƒ½æ˜¯æœ‰å·®å¼‚çš„ã€‚é€šè¿‡Code Reviewï¼Œå¯¹äºåŒæ ·çš„åŠŸèƒ½å®ç°ï¼Œæœ‰ç»éªŒçš„å·¥ç¨‹å¸ˆå¯ä»¥ç»™ç»éªŒå°šæµ…çš„å·¥ç¨‹å¸ˆæä¾›åˆç†çš„ä¼˜åŒ–å»ºè®®ã€‚ç»éªŒå°šæµ…çš„å·¥ç¨‹å¸ˆå¯ä»¥é€šè¿‡é˜…è¯»ä¼˜è´¨ä»£ç ï¼Œå¿«é€Ÿå­¦ä¹ ç›¸å…³æŠ€æœ¯è¿ç”¨çš„æœ€ä½³å®è·µã€‚å¦‚æœå¤§å®¶æŠ€æœ¯å®åŠ›ç›¸å½“ï¼Œå°±æ˜¯äº’ç›¸åˆ·æ–°æ€æƒ³äº†ã€‚

### åœºæ™¯

- æ–°äººå‰å‡ æ¬¡å¼€å‘å®Œæˆéœ€æ±‚æ—¶
- é‡è¦çš„åŠŸèƒ½æ¨¡å—å¼€å‘å®Œæˆæ—¶
- ......

### Code Review çš„å¥½å¤„ğŸ‘

- æå‰å‘ç°é—®é¢˜
  > é—®é¢˜æš´éœ²çš„è¶Šæ™šï¼Œé£é™©ä¹Ÿå°±è¶Šå¤§ã€‚Code Review è‡³å°‘èƒ½æå‰å‘ç°æµç¨‹æˆ–è€…å®ç°ä¸Šçš„é—®é¢˜ã€‚
- æå‡ä»£ç è´¨é‡
  > æ²¡æœ‰äººReviewçš„ä»£ç ï¼Œå…¶ä»£ç æ°´å‡†å°±æ˜¯å†™ä»£ç äººçš„æ°´å‡†ï¼Œè€Œè¢«ä¸€ä¸ªå›¢é˜ŸReviewè¿‡çš„ä»£ç ï¼Œå®ƒçš„æ°´å‡†å°†æ¥è¿‘ç”šè‡³è¶…è¿‡æ•´ä¸ªå›¢é˜Ÿçš„æœ€é«˜æ°´å‡†ã€‚
- ç»éªŒå’ŒçŸ¥è¯†çš„ä¼ é€’
- ......

## GitLab Code ReviewğŸ“Œ

GitLabå¯ä»¥åœ¨åˆ†æ”¯åˆå¹¶çš„æ—¶å€™æ”¯æŒä¸¤ç§æ–¹å¼ï¼š

1. åœ¨æœ¬åœ°å°†æºåˆ†æ”¯(Source branch)ä»£ç åˆå¹¶åˆ°ç›®æ ‡åˆ†æ”¯ï¼ˆTarget branchï¼‰ç„¶å`Push`åˆ°ç›®æ ‡åˆ†æ”¯ï¼ˆTarget branchï¼‰
2. å°†æºåˆ†æ”¯(Source branch)`Push`åˆ°è¿œç«¯ï¼Œç„¶ååœ¨GitLabæŒ‡å®šç›®æ ‡åˆ†æ”¯ï¼ˆTarget branchï¼‰å‘èµ·`Merge Request`(ç®€ç§°MR)ï¼Œå¯¹ç›®æ ‡åˆ†æ”¯ï¼ˆTarget branchï¼‰æ‹¥æœ‰`Push`æƒé™çš„ç”¨æˆ·æ‰§è¡Œ`Merge`æ“ä½œï¼Œå®Œæˆåˆå¹¶ã€‚

### GitLab Code Review é…ç½®

#### å·¥ä½œæµ

æˆ‘ä»¬å½“å‰çš„å·¥ä½œæµå¦‚ä¸‹
![å½“å‰çš„å·¥ä½œæµ](./image/develop_workflow.png)

1. éœ€æ±‚ç¡®è®¤åå¼€å‘äººå‘˜ä»`develop/master`åˆ†æ”¯åˆ›å»ºè‡ªå·±çš„`feature`åˆ†æ”¯è¿›è¡Œå¼€å‘
2. éœ€æ±‚å¼€å‘å®Œæˆåï¼Œéœ€è¦ä»æœ€æ–°`develop`åˆ†æ”¯åˆå¹¶åˆ°è‡ªå·±çš„`feature`åˆ†æ”¯ï¼Œç„¶åå‘å¸ƒåˆ°æµ‹è¯•ç¯å¢ƒè¿›è¡Œæµ‹è¯•
3. `feature`åˆ†æ”¯æµ‹è¯•é€šè¿‡ååˆå¹¶åˆ°`develop`åˆ†æ”¯ï¼Œç­‰å¾…ç­è½¦ä¸Šçº¿
4. `develop`åˆ†æ”¯åˆå¹¶åˆ°`master`åˆ†æ”¯å¹¶å‘å¸ƒåˆ°ç”Ÿäº§ç¯å¢ƒ

#### Code Review æ—¶æœº

ä»¥ä¸Šè¿°Gitå·¥ä½œæµä¸ºä¾‹ï¼Œå¼€å‘äººå‘˜åœ¨`Feature`åˆ†æ”¯è¿›è¡Œå¼€å‘ï¼Œå¼€å‘å®Œæˆåä»ç„¶åœ¨`Feature`åˆ†æ”¯è¿›è¡Œæµ‹è¯•ã€‚

åŸºäºå½“å‰çš„å·¥ä½œæµï¼Œä¸ºäº†ä¿è¯ææµ‹è´¨é‡ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ææµ‹ä¹‹å‰å‘èµ·`Feature`åˆ°`Develop`åˆ†æ”¯çš„`Merge Request`ï¼Œä»£ç å®¡æŸ¥å®Œæˆå¹¶ä¸”é€šè¿‡æµ‹è¯•åå°†`Feature`åˆ†æ”¯åˆå¹¶åˆ°`Develop`åˆ†æ”¯.
![Code Review æ—¶æœº](./image/code_review_workflow.png)

### GitLab Code Review æµç¨‹

Code Review ä¸­è‡³å°‘åº”æœ‰ä¸¤ç§è§’è‰²ï¼š

- `developer` (å¼€å‘è€…)
- `reviewer` (å®¡æŸ¥è€…)

Code Review æµç¨‹ï¼š

1. å˜æ›´ `feature` åˆ†æ”¯ï¼Œå¹¶å°†å…¶ `push` åˆ°è¿œç¨‹åˆ†æ”¯ï¼ˆdeveloperï¼‰
2. åœ¨ `Gitlab` é¡µé¢ä¸Šåˆ›å»º **`Merge Request`**ï¼ˆdeveloperï¼‰
![åˆ›å»º merge request](./image/create_merge_request.png)
![é€‰æ‹©åˆ†æ”¯](./image/choose_branch.png)
3. å®¡æŸ¥ä»£ç  (reviewer)
![å®¡æŸ¥ä»£ç ](./image/review_list.png)
![å®¡æŸ¥é¢æ¿](./image/review_panel.png)
![è¯„è®ºä»£ç ](./image/comment_code.png)
![å®Œç»“è¯„è®º](./image/resolved_comment.png)
![åŒæ„åˆå¹¶](./image/approve_request.png)

ä¸Šé¢çš„æµç¨‹å­˜åœ¨çš„é—®é¢˜ï¼š

1. `Review` è¿‡ç¨‹ä¸­æ‰€æœ‰çš„æ“ä½œéƒ½éœ€è¦å£å¤´å‘ŠçŸ¥å¯¹åº”`developer/reviewer`
2. åˆ›å»º`MR`è¿‡ç¨‹æ¯”è¾ƒç¹çï¼Œéœ€è¦å¡«å†™çš„ä¿¡æ¯è¿‡å¤š

## é’‰é’‰æœºå™¨äººğŸ¤–ï¸

åœ¨é’‰é’‰ï¼Œæœºå™¨äººæ˜¯ç‹¬ç«‹å­˜åœ¨çš„ä¸€ä¸ªåº”ç”¨ç±»å‹ï¼Œå¯ä»¥å¼€ç®±å³ç”¨ï¼Œä¹Ÿå¯ä»¥è¿›è¡ŒäºŒæ¬¡å¼€å‘ï¼Œä¸»è¦ç”¨æ¥æ¨é€å¾®åº”ç”¨çš„é€šçŸ¥å’Œç”¨æ¥å¯¹ç”¨æˆ·è¿›è¡Œå¯¹è¯å¼æœåŠ¡ã€‚

å®˜æ–¹æ–‡æ¡£ï¼š[https://open.dingtalk.com/document/robots/robot-overview](https://open.dingtalk.com/document/robots/robot-overview)

### Gitlab æœºå™¨äºº

ä½¿ç”¨é’‰é’‰ç¾¤è‡ªå¸¦çš„ `gitlab` æœºå™¨äººç»“åˆ `gitlab webhook` å®ç° `merge request` æ¶ˆæ¯é€šçŸ¥ï¼š
![é€‰æ‹©é’‰é’‰æœºå™¨äºº](./image/choose_robot.png)
![gitlab æœºå™¨äºº](./image/gitlab_robot.png)
è¿™ç§æ–¹å¼å¯ä»¥åšåˆ°ç®€å•çš„ç¾¤æ¶ˆæ¯é€šçŸ¥ï¼Œè€Œæƒ³è¦åšåˆ°æ›´å…·ä½“çš„é€šçŸ¥ï¼ˆæ¯”å¦‚ @ å‚ä¸æ­¤æ¬¡ Review çš„æˆå‘˜ï¼‰ï¼Œåˆ™éœ€è¦ç”¨åˆ°è‡ªå®šä¹‰æœºå™¨äºº

### è‡ªå®šä¹‰æœºå™¨äºº

`GitLab` ä¸Šçš„æ“ä½œï¼Œä¹‹æ‰€ä»¥èƒ½å¤ŸæŠŠæ¶ˆæ¯æ¨é€åˆ°å¯¹åº”é’‰é’‰ç¾¤ï¼Œæœ¬è´¨ä¸Šæ˜¯å€ŸåŠ©äº `Webhooks` å’Œé’‰é’‰ç¾¤æ¶ˆæ¯æœºå™¨äººçš„èƒ½åŠ›ï¼Œå…¶æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤º:
![dd_gitlab_robot_workflow](./image/dd_gitlab_robot_workflow.png)

ä¸Šè¿°æµç¨‹ä¸­ï¼Œç»™é’‰é’‰ç¾¤æ¨é€ä»€ä¹ˆæ ·æ ¼å¼çš„æ¶ˆæ¯æ˜¯ç”±é’‰é’‰ç¾¤"GitLabæœºå™¨äºº"æœåŠ¡æ¥åšçš„ï¼Œé‚£ä¹ˆå¦‚æœè¦è‡ªå®šä¹‰æ¨é€åˆ°é’‰é’‰ç¾¤çš„æ¶ˆæ¯å†…å®¹ï¼Œåªéœ€è¦æ›¿æ¢æ‰é’‰é’‰ç¾¤â€GitLabæœºå™¨äººâ€œçš„é»˜è®¤æœåŠ¡å³å¯ï¼Œæµç¨‹å›¾å¦‚ä¸‹æ‰€ç¤º:

![dd_custom_robot_workflow](./image/dd_custom_robot_workflow.png)

ä½¿ç”¨è‡ªå®šä¹‰æœºå™¨äººéœ€è¦è‡ªå»º`Nodejs`æœåŠ¡ï¼Œå…·ä½“å®ç°æµç¨‹å¦‚ä¸‹ï¼š

1. é’‰é’‰ç¾¤åˆ›å»ºè‡ªå®šä¹‰æœºå™¨äººï¼Œå¾—åˆ°æ¨é€æ¶ˆæ¯`url`
2. åˆ›å»º `Nodejs` æœåŠ¡å™¨ï¼Œæš´éœ²ä¸€ä¸ªæ¥å£ç»™ `Gitlab Webhook`
3. ç¼–å†™æ¥å£é€»è¾‘ï¼Œå¤„ç† `Gitlab Webhook` å‘é€è¿‡æ¥çš„è¯·æ±‚
4. æ‹¼æ¥å¥½è¦å‘é€åˆ°é’‰é’‰ç¾¤çš„æ¶ˆæ¯ï¼Œå‘è‡ªå®šä¹‰æœºå™¨äºº`url`å‘é€è¯·æ±‚

### è‡ªå®šä¹‰æœºå™¨äººç»“åˆ GitLab MR çš„ Code Review ğŸ› 

![custom_mr_create](./image/custom_mr_create.png)
![custom_robot](./image/custom_robot.png)

## NodeJs è„šæœ¬åˆ›å»º MR ğŸ“

ä¸ºäº†è¿›ä¸€æ­¥ç¼©çŸ­ `Code Review` é“¾è·¯ï¼Œä¾¿æœ‰äº†ä»¥ä¸‹è¯‰æ±‚ï¼š

- èƒ½å¦ä¸ç™»é™†åˆ° `Gitlab` ç½‘é¡µï¼Œåœ¨æœ¬åœ°å°±å¯ä»¥åˆ›å»º `MR`ï¼Ÿ

`GitLab`æä¾›äº†ä¸°å¯Œçš„`API`ä¾›æˆ‘ä»¬ä½¿ç”¨ï¼Œè®©æˆ‘ä»¬å¯ä»¥æ— éœ€ç™»é™†åˆ°`GitLab`é¡µé¢å°±å¯ä»¥è¿›è¡Œä¸€äº›æ“ä½œã€‚APIåœ°å€ä¸º `gitlabåœ°å€/help/api/README.md`

å…¶ä¸­å°±åŒ…æ‹¬åˆ›å»º `MR` çš„`API`ï¼ŒåŸºäºæ­¤`API`ä¾¿å¯ä»¥ç¼–å†™`NodeJs`è„šæœ¬ï¼Œåœ¨å‘½ä»¤è¡Œäº¤äº’å¼çš„åˆ›å»º`MR`ï¼Œè®©æˆ‘ä»¬èƒ½åœ¨ç¼–è¾‘å™¨æ§åˆ¶å°åˆ›å»º`MR`ï¼Œæ•´ä¸ªæµç¨‹çœ‹èµ·æ¥åƒè¿™æ ·ï¼š

![mr_process](./image/mr_process.png)

1. åœ¨æœ¬åœ°ç¼–è¾‘å™¨æˆ–å‘½ä»¤è¡Œè¿è¡Œè„šæœ¬ï¼Œäº¤äº’å¼åˆ›å»º`MR`
2. `GitLab`æ¥æ”¶åˆ°åˆ›å»º`MR`è¯·æ±‚ï¼Œåˆ›å»º`MR`åè§¦å‘`WebHook`å‘é€è¯·æ±‚åˆ°`Nodejs`æœåŠ¡
3. `Nodejs`æœåŠ¡å¤„ç†`GitLab`è¯·æ±‚ï¼Œè½¬æ¢æˆé’‰é’‰æœºå™¨äººéœ€è¦çš„æ ¼å¼ï¼Œå‘é€è¯·æ±‚ç»™é’‰é’‰æœºå™¨äºº`Webhook`
4. é’‰é’‰æ”¶åˆ°è¯·æ±‚ï¼Œå°†æ¶ˆæ¯å‘é€åˆ°ç¾¤èŠï¼Œ`Code Review`æˆå‘˜ç‚¹å‡»`MR`é“¾æ¥è¿›å…¥åˆ°`GitLab MR`é¡µé¢ï¼Œå¼€å§‹æ­¤æ¬¡ä»£ç å®¡æŸ¥
5. `Code Review` ä¸­å¯¹`MR`çš„æ›´æ–°ã€å®¡æ‰¹ã€è¯„è®ºç­‰æ“ä½œéƒ½å°†è§¦å‘`GitLab Webhook`ï¼Œå½¢æˆé—­ç¯

### åˆ›å»º Access Token

åŸºæœ¬`GitLab`çš„é‰´æƒæœºåˆ¶ï¼Œä½¿ç”¨è„šæœ¬å‰éœ€è¦å…ˆåœ¨`GitLab`ä¸­åˆ›å»ºè‡ªå·±çš„ `access token`ï¼Œç”¨äºè®©`GitLab`éªŒè¯æˆ‘ä»¬çš„èº«ä»½ã€‚

å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼è¿›è¡Œèº«ä»½éªŒè¯ï¼š

- OAuth2 tokens
- Personal access tokens
- Project access tokens

åˆ›å»ºä¸ªäººè®¿é—®ä»¤ç‰Œï¼ˆPersonal access tokensï¼‰å³å¯ï¼Œåˆ›å»ºæµç¨‹å¦‚ä¸‹ï¼š

1. è¿›å…¥åˆ°`GitLab`ä¸­çš„ç”¨æˆ·è®¾ç½®é¡µé¢
  ![GitLabä¸­çš„ç”¨æˆ·è®¾ç½®é¡µé¢](./image/gitlab_profile.png)
2. åˆ›å»ºä¸ªäººè®¿é—®ä»¤ç‰Œï¼ˆPersonal access tokensï¼‰
  ![åˆ›å»ºä¸ªäººè®¿é—®ä»¤ç‰Œ](./image/gitlab_create_access_token.png)

å°†åˆ›å»ºå¥½çš„`access token`å¡«å…¥åˆ°è„šæœ¬ä¸­ï¼Œè„šæœ¬è·¯å¾„ä¸ºï¼š`bin/create_mr.js`

  ```javascript
  const ACCESS_TOKEN = 'ä½ çš„token';
  ```

### ä½¿ç”¨è„šæœ¬

å‘½ä»¤è¡Œè¾“å…¥ï¼š`npm run create:mr`

æ ¹æ®æç¤ºè¾“å…¥MRæ ‡é¢˜ã€æè¿°ï¼Œç„¶åé€‰æ‹©reviewerå³å¯

## ------

> æœ¬æ–‡å‚è€ƒé“¾æ¥ğŸ”—ï¼š<br/>
> [å¦‚ä½•åœ¨å›¢é˜Ÿä¸­åšå¥½Code Review](https://ken.io/note/how-to-do-code-review-in-a-team)<br/>
> [åŸºäºGitLabçš„Code Reviewæ•™ç¨‹](https://ken.io/note/gitlab-code-review-tutorial#H3-6)<br/>
> [GitLab merge request ç»“åˆé’‰é’‰ç¾¤æ¶ˆæ¯æœºå™¨äººçš„å…¨è‡ªåŠ¨ Code Review å®è·µ](https://juejin.cn/column/7066714281068199972)
